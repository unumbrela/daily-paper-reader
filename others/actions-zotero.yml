type: ActionsTagsBackup
author: zwwen0711
platformVersion: 7.0.30
pluginVersion: 2.2.4
timestamp: '2025-12-28T17:22:32.173Z'
actions:
  1766933168242-lENQeb2s:
    event: 1
    operation: 4
    data: >-
      // === 1. å®šä¹‰æ ‡è®° ===

      const MARKER_SUMMARY = "ã€ğŸ¤– AI Summaryã€‘";

      const MARKER_CHAT = "ã€ğŸ’¬ Chat Historyã€‘";

      const MARKER_ORIG = "ã€ğŸ“„ Original Abstractã€‘";


      // å‰ç«¯ä¼ æ¥çš„å ä½ç¬¦

      const BR_PLACEHOLDER = /__BR__/g; 


      // === 2. è·å–é€‰ä¸­æ¡ç›® (é’ˆå¯¹ Actions & Tags ä¼˜åŒ–) ===

      // æ’ä»¶ä¼šè‡ªåŠ¨æ³¨å…¥ 'item' (å•ä½“) æˆ– 'items' (æ•°ç»„) å˜é‡

      var targetItem = null;


      if (typeof item !== 'undefined') {
          targetItem = item;
      } else if (typeof items !== 'undefined' && items.length > 0) {
          // å¦‚æœæ˜¯æ‰¹é‡é€‰ä¸­ï¼Œæœ¬è„šæœ¬é€»è¾‘è¾ƒå¤æ‚ï¼Œå»ºè®®æš‚æ—¶åªå¤„ç†ç¬¬ä¸€ä¸ª
          // æˆ–è€…ä½ å¯ä»¥é…åˆæ’ä»¶çš„ "Batch" æ¨¡å¼ä½¿ç”¨
          targetItem = items[0];
      }


      if (!targetItem) return "âŒ é”™è¯¯ï¼šæœªæ¥æ”¶åˆ°æœ‰æ•ˆæ¡ç›® (è¯·ç¡®ä¿é€‰ä¸­äº†æ¡ç›®)";



      // === 3. æ£€æŸ¥å†…å®¹ ===

      var fullText = targetItem.getField('abstractNote');

      if (!fullText || !fullText.includes("AI Summary")) {
          return "âš ï¸ æ‘˜è¦é‡Œæ²¡æ‰¾åˆ° 'AI Summary' æ ‡è®°ï¼Œè·³è¿‡ã€‚";
      }


      // === 4. æå–æ•°æ® ===

      var pSummary = fullText.indexOf(MARKER_SUMMARY);

      var pChat = fullText.indexOf(MARKER_CHAT);

      var pOrig = fullText.indexOf(MARKER_ORIG);


      if (pOrig === -1) return "âŒ æ‰¾ä¸åˆ° Original Abstract æ ‡è®°ã€‚";


      var summaryEnd = (pChat > -1) ? pChat : pOrig;


      var rawSummary = fullText.substring(pSummary + MARKER_SUMMARY.length,
      summaryEnd).trim();

      var rawChat = "";

      if (pChat > -1) {
          rawChat = fullText.substring(pChat + MARKER_CHAT.length, pOrig).trim();
      }

      var rawOrig = fullText.substring(pOrig + MARKER_ORIG.length).trim();



      // === 5. ã€æ ¸å¿ƒé€»è¾‘ã€‘ç”Ÿæˆå¯¹è¯æ°”æ³¡ ===

      function formatChatHistory(rawChatString) {
          if (!rawChatString) return "";

          let segments = rawChatString.split(/(?=ğŸ‘¤ User:|ğŸ¤– AI:)/g);
          let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';

          segments.forEach(seg => {
              seg = seg.trim();
              if (!seg) return;

              // è¿˜åŸæ¢è¡Œç¬¦
              let cleanText = seg.replace(BR_PLACEHOLDER, "\n").trim();
              
              if (cleanText.startsWith("ğŸ‘¤ User:")) {
                  let content = cleanText.replace("ğŸ‘¤ User:", "").trim();
                  // User: æ˜æ˜¾æ·¡è“è‰² (#bbdefb)
                  html += `
                      <div style="align-self: flex-end; max-width: 85%;">
                          <strong style="display:block; color:#0d47a1; font-size:0.8em; margin-bottom:4px; text-align:right;">ğŸ‘¤ User</strong>
                          <pre style="
                              display: block !important;
                              background-color: #bbdefb;
                              color: #0d47a1;
                              padding: 15px;
                              border-radius: 15px 15px 0 15px;
                              white-space: pre-wrap;
                              font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                              margin: 0;
                              font-size: 1em;
                              line-height: 1.5;
                              border: none;
                              box-shadow: 1px 1px 2px rgba(0,0,0,0.05);
                          ">${content}</pre>
                      </div>
                  `;
              } else if (cleanText.startsWith("ğŸ¤– AI:")) {
                  let content = cleanText.replace("ğŸ¤– AI:", "").trim();
                  // AI: ç°è‰²
                  html += `
                      <div style="align-self: flex-start; max-width: 90%;">
                          <strong style="display:block; color:#616161; font-size:0.8em; margin-bottom:4px;">ğŸ¤– AI</strong>
                          <pre style="
                              display: block !important;
                              background-color: #f5f5f5;
                              color: #333;
                              padding: 15px;
                              border-radius: 15px 15px 15px 0;
                              white-space: pre-wrap;
                              font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                              margin: 0;
                              font-size: 1em;
                              line-height: 1.5;
                              border: 1px solid #e0e0e0;
                          ">${content}</pre>
                      </div>
                  `;
              }
          });

          html += '</div>';
          return html;
      }


      // === 6. ç»„è£… & ä¿å­˜ ===


      // Summary: çº¯ç™½èƒŒæ™¯ + <br>æ¢è¡Œä¿®å¤

      let summaryContent = rawSummary
          .replace(BR_PLACEHOLDER, "\n")
          .replace(/\n/g, "<br>"); 

      var aiSummaryHTML = `
          <div style="
              display: block;
              background-color: transparent; 
              color: #333;
              font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
              font-size: 1em; 
              line-height: 1.6;
              border: none;
          ">${summaryContent}</div>
      `;


      var chatHTML = formatChatHistory(rawChat);

      var originalAbstract = rawOrig.replace(BR_PLACEHOLDER, "\n");


      var noteHTML = `
          <div style="font-family: -apple-system, BlinkMacSystemFont, sans-serif; color: #333;">
              
              <h2 style="
                  background: transparent; 
                  color: #0277bd; 
                  padding: 0; 
                  margin-bottom: 15px; 
                  border-bottom: 2px solid #e1f5fe; 
                  display: inline-block;
              ">
                  ğŸ¤– AI Summary
              </h2>
              
              <div style="margin-bottom: 30px;">
                  ${aiSummaryHTML}
              </div>
      `;


      if (chatHTML) {
          noteHTML += `
              <hr style="border: 0; border-top: 2px dashed #ccc; margin: 30px 0;">
              
              <h3 style="
                  background: transparent; 
                  color: #444; 
                  padding: 0; 
                  margin-bottom: 20px;
                  border-bottom: 2px solid #eee;
                  display: inline-block;
              ">
                  ğŸ’¬ Chat History
              </h3>
              
              ${chatHTML}
          `;
      }

      noteHTML += `</div>`;


      // å†™å…¥

      let newNote = new Zotero.Item('note');

      newNote.setNote(noteHTML);

      newNote.parentID = targetItem.id;

      await newNote.saveTx();


      targetItem.setField('abstractNote', originalAbstract);

      await targetItem.saveTx();


      return "ğŸ¤– AI Summary: âœ… å¤„ç†å®Œæˆ";
    shortcut: ''
    enabled: true
    menu: ''
    name: Process AI Summary
    showInMenu:
      item: false
      collection: false
      tools: false
      reader: false
      readerAnnotation: false
