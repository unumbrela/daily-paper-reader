<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>Daily Paper Reader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta name="citation_journal_title" content="Daily Paper Reader (ArXiv)">
  <meta name="citation_title" content="Daily Paper Reader Default Entry">
  <meta name="citation_author" content="Daily Paper Reader Team">
  <meta name="citation_author" content="Docsify Renderer">
  <meta name="citation_date" content="2024/01/01">
  <meta name="citation_pdf_url" content="https://daily-paper-reader.invalid/default.pdf">
  <meta name="citation_volume" content="1">
  <meta name="citation_issue" content="1">
  <meta name="citation_firstpage" content="100">
  <meta name="citation_lastpage" content="110">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
  
  <style>
    /* è¯„è®ºåŒºå®¹å™¨ */
    #paper-chat-container {
      margin-top: 50px;
      padding-top: 20px;
      border-top: 1px solid #eaecef;
    }
    .chat-header { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; }
    
    /* æ¶ˆæ¯åˆ—è¡¨ */
    #chat-history {
      max-height: 500px;
      overflow-y: auto;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .msg-item { margin-bottom: 12px; }
    .msg-role { font-weight: bold; font-size: 0.9rem; }
    .msg-role.user { color: #42b983; } /* ç”¨æˆ·ç»¿è‰² */
    .msg-role.ai { color: #3b8eed; }   /* AI è“è‰² */
    .msg-content { margin-top: 4px; line-height: 1.6; color: #34495e; white-space: pre-wrap; }
    .msg-time { font-size: 0.8rem; color: #999; margin-left: 10px; }

    /* è¾“å…¥åŒºåŸŸ */
    .input-area { display: flex; gap: 10px; }
    #user-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    #send-btn {
      padding: 0 20px;
      background: #42b983;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    #send-btn:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <div id="app">åŠ è½½ä¸­...</div>

  <script>
    window.$docsify = {
      name: 'Daily Paper Reader',
      repo: '',
      loadSidebar: true, // å¼€å¯ä¾§è¾¹æ 
      subMaxLevel: 2,
      
      // --- æ ¸å¿ƒï¼šæ³¨å†Œè‡ªå®šä¹‰æ’ä»¶ ---
      plugins: [
        function(hook, vm) {
          // 1. è§£æå½“å‰æ–‡ç«  ID (ç®€å•ç”¨æ–‡ä»¶åä½œä¸º ID)
          const getPaperId = () => {
            return vm.route.file.replace('.md', ''); 
          };

          const metaFallbacks = {
            citation_title: 'Daily Paper Reader Default Entry',
            citation_journal_title: 'Daily Paper Reader (ArXiv)',
            citation_pdf_url: 'https://daily-paper-reader.invalid/default.pdf',
            citation_publication_date: '2024-01-01',
            citation_date: '2024/01/01'
          };

          const defaultAuthors = ['Daily Paper Reader Team', 'Docsify Renderer'];

          const updateMetaTag = (name, content, options = {}) => {
            const old = document.querySelector(`meta[name="${name}"]`);
            if (old) old.remove();
            const useFallback = options.useFallback !== false;
            const value = content || (useFallback ? metaFallbacks[name] : '');
            if (!value) return;
            const meta = document.createElement('meta');
            meta.name = name;
            meta.content = value;
            document.head.appendChild(meta);
          };

          // 2. æ¸²æŸ“è¯„è®ºåŒºçš„ HTML ç»“æ„
          const renderChatUI = () => {
            return `
              <div id="paper-chat-container">
                <div class="chat-header">ğŸ’¬ å…¬å…±ç ”è®¨åŒº (Public Discussion)</div>
                <div id="chat-history">
                    <div style="text-align:center; color:#999">æ­£åœ¨åŠ è½½è®¨è®ºè®°å½•...</div>
                </div>
                <div class="input-area">
                  <textarea id="user-input" rows="3" placeholder="é’ˆå¯¹è¿™ç¯‡è®ºæ–‡æé—®ï¼Œæ‰€æœ‰äººå¯è§..."></textarea>
                  <button id="send-btn">å‘é€</button>
                </div>
              </div>
            `;
          };

          // 3. è·å–å†å²è®°å½• (API)
          const loadHistory = async (paperId) => {
            try {
              // è¿™é‡Œçš„ URL æ¢æˆä½ æœåŠ¡å™¨çš„çœŸå®åœ°å€
              const res = await fetch(`/api/history?paper_id=${encodeURIComponent(paperId)}`);
              const data = await res.json();
              
              const html = data.map(msg => `
                <div class="msg-item">
                  <div>
                    <span class="msg-role ${msg.role === 'ai' ? 'ai' : 'user'}">
                        ${msg.role === 'ai' ? 'ğŸ¤– AI åŠ©æ‰‹' : 'ğŸ‘¤ å­¦æœ¯è·¯äºº'}
                    </span>
                    <span class="msg-time">${msg.time || ''}</span>
                  </div>
                  <div class="msg-content">${msg.content}</div>
                </div>
              `).join('');
              
              document.getElementById('chat-history').innerHTML = html || '<div style="text-align:center; color:#999">æš‚æ— è®¨è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘ï¼</div>';
              
              // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
              const historyDiv = document.getElementById('chat-history');
              historyDiv.scrollTop = historyDiv.scrollHeight;
              
            } catch (e) {
              console.error("åŠ è½½å¤±è´¥", e);
            }
          };

          // 4. å‘é€æ¶ˆæ¯ (API)
          const sendMessage = async () => {
            const input = document.getElementById('user-input');
            const btn = document.getElementById('send-btn');
            const question = input.value.trim();
            const paperId = getPaperId();
            
            const paperContent = document.querySelector('.markdown-section').innerText; 

            if (!question) return;

            // UI é”å®š
            input.disabled = true;
            btn.disabled = true;
            btn.innerText = "æ€è€ƒä¸­...";
            
            // ä¹è§‚æ›´æ–°
            const historyDiv = document.getElementById('chat-history');
            historyDiv.innerHTML += `
                <div class="msg-item">
                    <div><span class="msg-role user">ğŸ‘¤ ä½ </span></div>
                    <div class="msg-content">${question}</div>
                </div>
            `;
            historyDiv.scrollTop = historyDiv.scrollHeight;

            try {
              const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    paper_id: paperId,
                    question: question,
                    paper_content: paperContent 
                })
              });
              const data = await res.json();
              await loadHistory(paperId);
              input.value = '';
            } catch (e) {
              alert("å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•");
            } finally {
              input.disabled = false;
              btn.disabled = false;
              btn.innerText = "å‘é€";
              input.focus();
            }
          };

          // --- Docsify ç”Ÿå‘½å‘¨æœŸé’©å­ ---
          
          hook.doneEach(function() {
            // A. å°† Chat UI è¿½åŠ åˆ°æ–‡ç« åº•éƒ¨
            const mainContent = document.querySelector('.markdown-section');
            if (mainContent) {
                const div = document.createElement('div');
                div.innerHTML = renderChatUI();
                mainContent.appendChild(div);
            }

            // B. ç»‘å®šäº‹ä»¶
            document.getElementById('send-btn').addEventListener('click', sendMessage);

            // C. åˆå§‹åŠ è½½æ•°æ®
            const paperId = getPaperId();
            loadHistory(paperId);

            // D. å¼€å¯è½®è¯¢
            if (window.chatTimer) clearInterval(window.chatTimer);
            window.chatTimer = setInterval(() => loadHistory(paperId), 10000);

            // ----------------------------------------------------
            // E. ã€é‡ç‚¹ä¿®æ”¹ã€‘Zotero å…ƒæ•°æ®æ³¨å…¥é€»è¾‘ (å¸¦å»¶æ—¶å’Œå”¤é†’)
            // ----------------------------------------------------
            setTimeout(() => {
                try {
                  // 1. æŠ“å–æ ‡é¢˜ (ä¼˜å…ˆæŠ“ H1)
                  const titleEl = document.querySelector('.markdown-section h1');
                  const title = titleEl ? titleEl.innerText : document.title;

                  // 2. æŠ“å– PDF é“¾æ¥ (ä¼˜å…ˆæŠ“ ArXiv)
                  let pdfLinkEl = document.querySelector('a[href*="arxiv.org/pdf"]');
                  // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå†è¯•ç€æ‰¾ä»»ä½•ç»“å°¾æ˜¯ .pdf çš„é“¾æ¥
                  if (!pdfLinkEl) {
                     pdfLinkEl = document.querySelector('a[href$=".pdf"]');
                  }
                  
                  let pdfUrl = '';
                  if (pdfLinkEl) {
                    // è½¬ä¸ºç»å¯¹è·¯å¾„
                    pdfUrl = new URL(pdfLinkEl.href, window.location.href).href;
                  }

                  // 3. æŠ“å–æ—¥æœŸ
                  let date = '';
                  const matchDate = vm.route.file.match(/(\d{4}-\d{2}-\d{2})/);
                  if (matchDate) {
                    date = matchDate[1];
                  }
                  const citationDate = date ? date.replace(/-/g, '/') : '';

                  // 4. æŠ“å–ä½œè€…
                  let authors = [];
                  document.querySelectorAll('.markdown-section p').forEach(p => {
                    if (p.innerText.includes('Authors:')) {
                      const text = p.innerText.replace('Authors:', '').trim();
                      authors = text.split(/,|ï¼Œ/).map(a => a.trim());
                    }
                  });

                  // 5. å†™å…¥ Meta æ ‡ç­¾
                  console.log("Updating Zotero metadata for:", title);
                  updateMetaTag('citation_title', title);
                  updateMetaTag('citation_journal_title', 'Daily Paper Reader (ArXiv)'); // å¿…é¡»æœ‰è¿™ä¸ª
                  updateMetaTag('citation_pdf_url', pdfUrl, { useFallback: false });
                  updateMetaTag('citation_publication_date', date);
                  updateMetaTag('citation_date', citationDate);

                  document.querySelectorAll('meta[name="citation_author"]').forEach(el => el.remove());
                  const authorList = authors.length ? authors : defaultAuthors;
                  authorList.forEach(author => {
                    const meta = document.createElement('meta');
                    meta.name = 'citation_author';
                    meta.content = author;
                    document.head.appendChild(meta);
                  });

                  // 6. ã€å…³é”®ã€‘å‘é€ Zotero æ›´æ–°äº‹ä»¶
                  // å‘Šè¯‰æ’ä»¶é‡æ–°æ‰«æé¡µé¢
                  document.dispatchEvent(new Event('ZoteroItemUpdated', {
                      bubbles: true,
                      cancelable: true
                  }));

                } catch (e) {
                  console.error('Zotero meta update failed:', e);
                }
            }, 1); // å»¶è¿Ÿ 800ms æ‰§è¡Œï¼Œç­‰å¾… DOM æ¸²æŸ“å®Œæ¯•
          });
        }
      ]
    }
  </script>
  
  <script src="//cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js"></script>
</body>
</html>